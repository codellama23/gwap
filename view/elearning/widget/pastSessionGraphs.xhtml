<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
    xmlns:s="http://jboss.com/products/seam/taglib"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:rich="http://richfaces.org/rich"
    xmlns:a4j="http://richfaces.org/a4j">

	<a4j:loadScript src="/javascript/processing.js" />
	<script type="text/javascript"> 
		function getScale(max, min, appearence){
			var scale = 1;
			if(appearence > min){
				scale = 15 * (appearence - min)/(max - min);
			}
			return 10 + scale;
		}

		function setLineBreaks(tag){
			tag = tag.trim();
			tag = tag.replace(/ +(?= )/g,''); //replace multiple whitespaces 
			tag = tag.replace(/ /g,"\n"); //replace whitespaces with linebreak
			return tag;
		}
	
		function dataQuery(){
			console.log("jquery");
			initializeVariables();
			jQuery.ajax({
				url      : "seam/resource/rest/pastTerminaSession/userResults", 
 				data	 : {'term': term, 'owr': ownWrongRequest, 'fwr': foreignWrongRequest},
				dataType : "json", 
				success  : dataCallback,
			});
		}

		function dataCallback(data){
			//data zerlegen
			console.log("callback");
			term = data["term"];
			//var userTags = data["userTags"];
			maxApp = data["maxApp"];
			minApp = data["minApp"];
			foreignTags = data["foreigns"];
			ownTags = data["owns"];

			displayData();
		}

		function displayData(){
			pjs = Processing.getInstanceById("TerminaGraph");
			pjs.setup();
			pjs.setTerm(setLineBreaks(term));
	
			for(var i = 0; i &lt; foreignTags.length; i++){
				var tag = foreignTags[i];
				console.log("foreign " + tag["tag"]);
				pjs.addForeignTag(setLineBreaks(tag["tag"]), 100, getScale(maxApp, minApp, tag["appearence"]), tag["matchType"]);
			}

			for(var i = 0; i &lt; ownTags.length; i++){
				var tag = ownTags[i];
				console.log("own " + tag["tag"]);
				pjs.addOwnTag(setLineBreaks(tag["tag"]), 100, getScale(maxApp, minApp, tag["appearence"]), tag["matchType"]);
			}

			pjs.separateTags();
			pjs.highlightOwnTags();
		}
		
		function setOwnWrongRequest(){
			ownWrongRequest = document.getElementById("selectionForm:chk1").checked;
		}	

		function setForeignWrongRequest(){
			foreignWrongRequest = document.getElementById("selectionForm:chk2").checked;
		}

		function setTerm(){
			term = document.getElementById("selectionForm:termSelection").value;
		}

		function initializeVariables(){
			console.log("init");
			maxApp = 1;
			minApp = 0;
			setTerm();
			setForeignWrongRequest();
			setOwnWrongRequest();
		}
		
	</script>


	<h:form id="selectionForm">
		<h:selectOneMenu id="termSelection" value="#{pastTerminaSession.termName}" onchange="setTerm(); dataQuery();" >
			<s:selectItems value="#{pastTerminaSession.playedTerms}" var="t" label="#{t.tag.name}" itemValue="#{t.tag.name}"></s:selectItems>
		</h:selectOneMenu>
		ownWrong:
		<h:selectBooleanCheckbox id="chk1" value="#{pastTerminaSession.ownWrongRequested}" onchange="setOwnWrongRequest(); dataQuery();"/>
		foreignWrong:
		<h:selectBooleanCheckbox id="chk2" value="#{pastTerminaSession.foreignWrongRequested}" onchange="setForeignWrongRequest(); dataQuery();" />
	</h:form>

	<canvas
		id="TerminaGraph"
		data-processing-sources="terminaGame/TerminaResultsMain.pde terminaGame/TerminaGraph.pde terminaGame/ResultGraph.pde terminaGame/Vertex.pde terminaGame/RoundedArc.pde">
	</canvas> 

</ui:composition>